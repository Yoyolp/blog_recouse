<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>f4k3 KTY 评分系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #e74c3c;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .button {
            padding: 12px 25px;
            font-size: 16px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #c0392b;
        }
        .button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .result-low {
            background-color: #d6eaf8;
            color: #2980b9;
        }
        .result-medium {
            background-color: #fdebd0;
            color: #e67e22;
        }
        .result-high {
            background-color: #d5f5e3;
            color: #27ae60;
        }
        .result-perfect {
            background-color: #ebdef0;
            color: #8e44ad;
        }
        .audio-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .audio-container h3 {
            margin-bottom: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 8px;
            width: 70%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: modalopen 0.4s;
        }
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-30px);}
            to {opacity: 1; transform: translateY(0);}
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover {
            color: #333;
        }
        .flag {
            margin: 30px 0;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
            background-color: #f9ebea;
            border: 2px dashed #e74c3c;
            border-radius: 5px;
        }
        .timer {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #e74c3c;
        }
        .visualizer {
            width: 100%;
            height: 60px;
            margin: 20px 0;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .similarity-meter {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .similarity-value {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #3498db, #2ecc71, #f1c40f, #e74c3c);
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e74c3c;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .cooldown {
            font-size: 18px;
            margin-top: 10px;
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            background-color: #fadbd8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            color: #c0392b;
        }
        /* 添加退出确认对话框样式 */
        .exit-confirm-modal {
            display: none;
            position: fixed;
            z-index: 2;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        
        .exit-confirm-content {
            position: relative;
            background-color: #fff2cc;
            margin: 15% auto;
            padding: 30px;
            border-radius: 8px;
            width: 70%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: modalopen 0.4s;
            border-left: 5px solid #e74c3c;
        }
        
        .exit-confirm-title {
            color: #e74c3c;
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .exit-confirm-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .exit-confirm-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .exit-confirm-stay {
            background-color: #3498db;
            color: white;
        }
        
        .exit-confirm-leave {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KTV 录音评分系统</h1>
            <p>大家都会逆战吧, have a try </p>
        </div>
        
        <div class="audio-container">
            <h3>逆战&张杰:</h3>
            <audio id="originalAudio" controls>
                <source id="originalAudioSource" src="/original.wav" type="audio/wav">
                您的浏览器不支持音频播放
            </audio>
        </div>
        
        <div id="warningMessage" class="warning" style="display:none;"></div>
        
        <div class="controls">
            <div id="timer" class="timer">00:00</div>
            <canvas id="visualizer" class="visualizer"></canvas>
            
            <div class="similarity-meter">
                <div id="similarityValue" class="similarity-value"></div>
            </div>
            
            <button id="recordButton" class="button">开始录音</button>
            <div id="cooldownTimer" class="cooldown" style="display:none;"></div>
            <div id="loader" class="loader"></div>
        </div>
        
        <div id="result" class="result" style="display:none;"></div>
        
        <!-- 录音预览 -->
        <div class="audio-container" id="recordingContainer" style="display:none;">
            <h3>你的录音:</h3>
            <audio id="recordedAudio" controls></audio>
        </div>
    </div>
    
    <!-- FLAG弹窗 -->
    <div id="flagModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>恭喜你！歌神级别！</h2>
            <p>你的演唱简直完美，获得了最高评价！</p>
            <div class="flag" id="flagContent"></div>
            <button class="button" onclick="closeModal()">谢谢</button>
        </div>
    </div>

    <div id="exitConfirmModal" class="exit-confirm-modal">
        <div class="exit-confirm-content">
            <div class="exit-confirm-title">⚠️ 警告</div>
            <p>若您退出当下页面，所有录制的录音都会被删除！</p>
            <div class="exit-confirm-buttons">
                <button id="stayButton" class="exit-confirm-stay">留在页面</button>
                <button id="leaveButton" class="exit-confirm-leave">确认退出</button>
            </div>
        </div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let microphone;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;
        let visualizerContext;
        
        // 时间
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 10000; // 10秒，与服务器端保持一致
        let cooldownInterval = null;

        // DOM元素
        const recordButton = document.getElementById('recordButton');
        const timer = document.getElementById('timer');
        const visualizer = document.getElementById('visualizer');
        const recordingContainer = document.getElementById('recordingContainer');
        const recordedAudio = document.getElementById('recordedAudio');
        const result = document.getElementById('result');
        const loader = document.getElementById('loader');
        const similarityValue = document.getElementById('similarityValue');
        const flagModal = document.getElementById('flagModal');
        const flagContent = document.getElementById('flagContent');
        const cooldownTimer = document.getElementById('cooldownTimer');
        const warningMessage = document.getElementById('warningMessage');
        const originalAudio = document.getElementById('originalAudio');
        const originalAudioSource = document.getElementById('originalAudioSource');
        
        originalAudio.addEventListener('error', function(e) {
            console.error('音频加载失败:', e);
            warningMessage.textContent = '原始音频加载失败，请刷新页面重试';
            warningMessage.style.display = 'block';
            
            fetch('/get-original-audio')
                .then(response => response.json())
                .then(data => {
                    if (data && data.url) {
                        console.log('从API获取音频URL:', data.url);
                        originalAudioSource.src = data.url + '?t=' + new Date().getTime(); // 添加时间戳防止缓存
                        originalAudio.load(); 
                    }
                })
                .catch(err => {
                    console.error('获取音频URL失败:', err);
                });
        });
        
        // 添加退出确认对话框元素
        const exitConfirmModal = document.getElementById('exitConfirmModal');
        const stayButton = document.getElementById('stayButton');
        const leaveButton = document.getElementById('leaveButton');
        

        let currentRecordingFilename = null;
        visualizerContext = visualizer.getContext('2d');
        visualizer.width = visualizer.offsetWidth;
        visualizer.height = visualizer.offsetHeight;
        
        recordButton.addEventListener('click', () => {
            if (!isRecording) {
                if (!canMakeRequest()) {
                    showCooldownMessage();
                    return;
                }
                
                // 如果有上一段录音，先清理
                if (currentRecordingFilename) {
                    cleanRecording(currentRecordingFilename);
                    currentRecordingFilename = null;
                }
                
                startRecording();
            } else {
                stopRecording();
            }
        });
        
        // 检查是否可以发送请求
        function canMakeRequest() {
            const now = Date.now();
            return now - lastRequestTime >= MIN_REQUEST_INTERVAL;
        }
        
        // 限时，避免过度请求
        function showCooldownMessage() {
            const now = Date.now();
            const remainingTime = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
            
            cooldownTimer.textContent = `请等待 ${remainingTime} 秒后再试`;
            cooldownTimer.style.display = 'block';
            
            if (cooldownInterval) {
                clearInterval(cooldownInterval);
            }
            
            cooldownInterval = setInterval(() => {
                const currentTime = Date.now();
                const remaining = Math.ceil((MIN_REQUEST_INTERVAL - (currentTime - lastRequestTime)) / 1000);
                
                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    cooldownTimer.style.display = 'none';
                    cooldownTimer.textContent = '';
                } else {
                    cooldownTimer.textContent = `请等待 ${remaining} 秒后再试`;
                }
            }, 1000);
        }
        
        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (elapsedTime % 60).toString().padStart(2, '0');
            timer.textContent = `${minutes}:${seconds}`;
        }
        
        // 可视化音频输入
        function visualize() {
            if (!audioContext || audioContext.state === 'closed') return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const draw = () => {
                if (!isRecording) return;
                
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                visualizerContext.clearRect(0, 0, visualizer.width, visualizer.height);
                
                const barWidth = (visualizer.width / bufferLength) * 2.5;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * visualizer.height;
                    
                    // 使用彩色渐变效果
                    const hue = i / bufferLength * 360;
                    visualizerContext.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    visualizerContext.fillRect(x, visualizer.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            };
            
            draw();
        }
        
        async function startRecording() {
            try {
                result.style.display = 'none';
                recordingContainer.style.display = 'none';
                warningMessage.style.display = 'none';
                
                try {
                    const prepareResponse = await fetch('/prepare-recording');
                    
                    if (!prepareResponse.ok) {
                        console.warn('预清理请求失败，继续录音:', prepareResponse.statusText);
                    } else {
                        // 检查内容类型
                        const contentType = prepareResponse.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await prepareResponse.json();
                            console.log('预清理结果:', data.message);
                        } else {
                            console.warn('预清理响应不是JSON格式，继续录音');
                        }
                    }
                } catch (cleanError) {
                    console.warn('预清理出错，继续录音:', cleanError);
                }
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('您的浏览器不支持录音功能。请使用Chrome, Firefox或Edge的最新版本。');
                }
                
                try {
                    // 获取录音权限
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    if (typeof MediaRecorder === 'undefined') {
                        throw new Error('您的浏览器不支持MediaRecorder API。请使用Chrome, Firefox或Edge的最新版本。');
                    }
                    
                    // 创建媒体记录器
                    let mimeType = 'audio/wav';
                    
                    // 检查浏览器是否支持指定的MIME类型
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        console.warn('浏览器不支持audio/wav格式，使用默认格式');
                        mimeType = '';
                    }
                    
                    const mediaRecorderOptions = mimeType ? 
                        { mimeType: mimeType, audioBitsPerSecond: 16000 } : 
                        { audioBitsPerSecond: 16000 };
                    
                    mediaRecorder = new MediaRecorder(stream, mediaRecorderOptions);
                    audioChunks = [];
                    
                    // 收集录音数据
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    // 录音停止后的处理
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        recordedAudio.src = audioUrl;
                        recordingContainer.style.display = 'block';
                        
                        uploadRecording(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.textContent = '停止录音';
                    recordButton.style.backgroundColor = '#c0392b';
                    
                    startTime = Date.now();
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 1000);
                    
                    visualize();
                    
                } catch (mediaError) {
                    handleMediaError(mediaError);
                }
                
            } catch (error) {
                console.error('录音功能错误:', error);
                showErrorMessage(error.message || '无法访问麦克风，请确保您已授予录音权限。');
            }
        }
        
        // 停止录音
        function stopRecording() {
            console.log('停止录音函数被调用，当前状态:', {
                isRecording: isRecording,
                mediaRecorderExists: !!mediaRecorder,
                mediaRecorderState: mediaRecorder ? mediaRecorder.state : 'undefined'
            });
            
            try {
                if (!mediaRecorder) {
                    console.error('MediaRecorder对象不存在，无法停止录音');
                    showErrorMessage('录音设备异常，请刷新页面重试');
                    isRecording = false;
                    recordButton.textContent = '开始录音';
                    recordButton.style.backgroundColor = '#e74c3c';
                    return;
                }
                
                if (!isRecording) {
                    console.warn('状态显示未在录音中，但停止录音按钮被点击');
                    return;
                }
                
                // 确保MediaRecorder处于录音状态才能停止
                if (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused') {
                    // 请求数据
                    mediaRecorder.requestData();
                    
                    // 停止录音
                    mediaRecorder.stop();
                    console.log('MediaRecorder已停止');
                } else {
                    console.warn(`MediaRecorder状态异常: ${mediaRecorder.state}`);
                }
                //UI更新
                isRecording = false;
                recordButton.textContent = '开始录音';
                recordButton.style.backgroundColor = '#e74c3c';
                
                // 停止计时器
                if (timerInterval) {
                    clearInterval(timerInterval);
                    console.log('计时器已停止');
                }
                
                // 关闭音频流
                if (audioContext && audioContext.state !== 'closed') {
                    if (microphone) {
                        microphone.disconnect();
                        console.log('麦克风已断开连接');
                    }
                }
                
                if (audioChunks.length > 0 && mediaRecorder.state !== 'recording') {
                    console.log('手动处理录音数据');
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    recordedAudio.src = audioUrl;
                    recordingContainer.style.display = 'block';
                    
                    // 上传录音
                    uploadRecording(audioBlob);
                }
            } catch (error) {
                console.error('停止录音时出错:', error);
                showErrorMessage('停止录音时出错，请刷新页面重试');
                
                isRecording = false;
                recordButton.textContent = '开始录音';
                recordButton.style.backgroundColor = '#e74c3c';
            }
        }
        
        // 处理媒体访问错误
        function handleMediaError(error) {
            console.error('麦克风访问错误:', error);
            
            let errorMessage = '无法访问麦克风，请确保您已授予录音权限。';
            
            // 根据错误类型提供具体的错误信息
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMessage = '您已拒绝麦克风访问权限。请点击浏览器地址栏的锁图标，更改麦克风权限设置，然后刷新页面。';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                errorMessage = '未检测到麦克风设备。请确认您的麦克风已正确连接，并且没有被系统禁用。';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                errorMessage = '麦克风正在被其他应用程序使用。请关闭可能正在使用麦克风的其他应用，然后刷新页面重试。';
            } else if (error.name === 'OverconstrainedError') {
                errorMessage = '麦克风设置约束条件无法满足。请使用其他麦克风设备重试。';
            } else if (error.name === 'TypeError') {
                errorMessage = '录音参数错误。请刷新页面重试。';
            } else if (error.name === 'AbortError') {
                errorMessage = '麦克风访问请求被中断。请刷新页面重试。';
            } else if (error.name === 'SecurityError') {
                errorMessage = '浏览器安全设置阻止了麦克风访问。请使用HTTPS连接或localhost访问本站点。';
            }
            
            showErrorMessage(errorMessage);
        }
        
        // 清理录音
        function cleanRecording(filename) {
            if (!filename) return;
            
            fetch(`/clean-recording/${filename}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                console.log('清理录音结果:', data.message);
            })
            .catch(error => {
                console.error('清理录音出错:', error);
            });
        }
        
        function cleanAllRecordings() {
            fetch('/clean-all-recordings', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                console.log('清理所有录音结果:', data.message);
            })
            .catch(error => {
                console.error('清理所有录音出错:', error);
            });
        }
        
        function uploadRecording(audioBlob) {
            loader.style.display = 'block';
            result.style.display = 'none';
            similarityValue.style.width = '0%';
            
            lastRequestTime = Date.now();
            
            
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');
            
            fetch('/compare-recording', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // 检查响应状态
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 隐藏加载状态
                loader.style.display = 'none';
                
                // 如果成功获取到录音文件名，保存它
                if (data.filename) {
                    currentRecordingFilename = data.filename;
                }
                
                // 显示匹配度
                const similarity = parseFloat(data.similarity);
                similarityValue.style.width = `${similarity}%`;
                
                // 显示结果
                result.textContent = `匹配度: ${similarity.toFixed(2)}% - ${data.message}`;
                result.style.display = 'block';
                
                // 根据匹配度设置不同的样式
                result.className = 'result';
                if (similarity >= 98) {
                    result.classList.add('result-perfect');
                } else if (similarity >= 85) {
                    result.classList.add('result-high');
                } else if (similarity >= 70) {
                    result.classList.add('result-medium');
                } else {
                    result.classList.add('result-low');
                }
                
                // 如果有FLAG，显示FLAG弹窗
                if (data.flag) {
                    showFlagModal(data.flag);
                }
            })
            .catch(error => {
                console.error('上传录音出错:', error);
                loader.style.display = 'none';
                result.textContent = '评分失败，请稍后重试: ' + error.message;
                result.className = 'result result-low';
                result.style.display = 'block';
            });
        }
        
        function showErrorMessage(message) {
            warningMessage.textContent = message;
            warningMessage.style.display = 'block';
            
            isRecording = false;
            recordButton.textContent = '开始录音';
            recordButton.style.backgroundColor = '#e74c3c';
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }
        
        // 显示FLAG弹窗
        function showFlagModal(flag) {
            flagContent.textContent = flag;
            flagModal.style.display = 'block';
        }
        
        function closeModal() {
            flagModal.style.display = 'none';
        }
        
        window.onclick = function(event) {
            if (event.target === flagModal) {
                flagModal.style.display = 'none';
            }
        }
        
        // 页面卸载前处理
        window.addEventListener('beforeunload', function(event) {
            // 显示确认对话框
            exitConfirmModal.style.display = 'block';
            
            // 阻止页面立即卸载，显示确认对话框
            event.preventDefault();
            event.returnValue = '';
            
            // 注意：现代浏览器出于安全考虑可能会忽略自定义消息
            return '若您退出当下页面，所有录制的录音都会被删除！';
        });
        
        // 用户选择页面
        stayButton.addEventListener('click', function() {
            exitConfirmModal.style.display = 'none';
        });
        
        leaveButton.addEventListener('click', function() {
            cleanAllRecordings();
            
            exitConfirmModal.style.display = 'none';
            
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 500);
        });

        // 在页面中添加文件选择按钮
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.accept = 'audio/wav';
fileInput.style.display = 'none';
document.body.appendChild(fileInput);

// 添加上传按钮
const uploadBtn = document.createElement('button');
uploadBtn.textContent = '上传本地WAV文件';
uploadBtn.className = 'button';
uploadBtn.onclick = () => fileInput.click();
document.querySelector('.controls').appendChild(uploadBtn);

// 文件选择处理
fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type === 'audio/wav') {
        // 显示预览
        recordedAudio.src = URL.createObjectURL(file);
        recordingContainer.style.display = 'block';
        
        // 直接上传
        uploadRecording(file);
    }
});
    </script>
</body>
</html>